class n{config;observer=null;formatSupport=new Map;constructor(e={}){this.config={enableWebP:!0,enableAVIF:!0,enableLazyLoading:!0,enableResponsive:!0,quality:85,sizes:[320,640,960,1280,1600,1920],formats:["avif","webp","jpg"],...e},this.detectFormatSupport()}init(){typeof window>"u"||(this.config.enableLazyLoading&&this.setupLazyLoading(),this.optimizeExistingImages(),this.config.enableResponsive&&this.setupResponsiveImages())}async detectFormatSupport(){const e=[{name:"avif",data:"data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI="},{name:"webp",data:"data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"}];for(const s of e)try{const t=await this.canDisplayImage(s.data);this.formatSupport.set(s.name,t)}catch{this.formatSupport.set(s.name,!1)}}canDisplayImage(e){return new Promise(s=>{const t=new Image;t.onload=()=>s(!0),t.onerror=()=>s(!1),t.src=e})}setupLazyLoading(){this.observer=new IntersectionObserver(e=>{e.forEach(s=>{if(s.isIntersecting){const t=s.target;this.loadImage(t),this.observer?.unobserve(t)}})},{rootMargin:"50px 0px",threshold:.01}),document.querySelectorAll("img[data-src]").forEach(e=>{this.observer?.observe(e)})}loadImage(e){const s=e.getAttribute("data-src"),t=e.getAttribute("data-srcset");s&&(e.src=s),t&&(e.srcset=t),e.removeAttribute("data-src"),e.removeAttribute("data-srcset"),e.classList.add("loaded"),e.style.opacity="0",e.style.transition="opacity 0.3s ease",e.onload=()=>{e.style.opacity="1"}}optimizeExistingImages(){document.querySelectorAll("img[data-optimize]").forEach(s=>{const t=s;this.optimizeImage(t)})}optimizeImage(e){const s=e.src||e.getAttribute("data-src");if(!s)return;const t=this.generateOptimizedSources(s);this.shouldUsePictureElement(t)?this.convertToPictureElement(e,t):this.config.enableResponsive&&(e.srcset=this.generateSrcset(s),e.sizes=this.generateSizes()),this.config.enableLazyLoading&&(e.loading="lazy"),e.decoding="async"}generateOptimizedSources(e){const s=[];for(const t of this.config.formats)if(this.formatSupport.get(t)){const A=this.generateSrcsetForFormat(e,t);s.push({format:t,srcset:A})}return s}generateSrcsetForFormat(e,s){const t=e.replace(/\.[^/.]+$/,""),A=s==="jpg"?"jpg":s;return this.config.sizes.map(a=>`${t}-${a}w.${A} ${a}w`).join(", ")}generateSrcset(e){const s=e.replace(/\.[^/.]+$/,""),t=e.split(".").pop();return this.config.sizes.map(A=>`${s}-${A}w.${t} ${A}w`).join(", ")}generateSizes(){return["(max-width: 320px) 320px","(max-width: 640px) 640px","(max-width: 960px) 960px","(max-width: 1280px) 1280px","1600px"].join(", ")}shouldUsePictureElement(e){return e.length>1&&(this.formatSupport.get("avif")||this.formatSupport.get("webp"))}convertToPictureElement(e,s){const t=document.createElement("picture");s.forEach(({format:a,srcset:r})=>{const i=document.createElement("source");i.srcset=r,i.type=`image/${a}`,i.sizes=this.generateSizes(),t.appendChild(i)});const A=e.cloneNode(!0);t.appendChild(A),e.parentNode?.replaceChild(t,e)}setupResponsiveImages(){window.addEventListener("resize",this.debounce(()=>{this.updateResponsiveImages()},250)),window.addEventListener("orientationchange",()=>{setTimeout(()=>{this.updateResponsiveImages()},100)})}updateResponsiveImages(){document.querySelectorAll("img[srcset]").forEach(s=>{const t=s,A=t.currentSrc;t.srcset=t.srcset,A!==t.currentSrc&&console.log("Image source updated:",t.currentSrc)})}createOptimizedImage(e,s,t={}){return{src:e,alt:s,srcset:this.generateSrcset(e),sizes:this.generateSizes(),loading:this.config.enableLazyLoading?"lazy":"eager",decoding:"async",...t}}preloadCriticalImages(e){e.forEach(s=>{const t=document.createElement("link");t.rel="preload",t.as="image",t.href=s,this.config.enableResponsive&&(t.setAttribute("imagesrcset",this.generateSrcset(s)),t.setAttribute("imagesizes",this.generateSizes())),document.head.appendChild(t)})}debounce(e,s){let t;return(...A)=>{clearTimeout(t),t=setTimeout(()=>e(...A),s)}}cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null)}}export{n as default};
